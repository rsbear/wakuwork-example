"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _export(target,all){for(var name in all)Object.defineProperty(target,name,{enumerable:true,get:all[name]})}_export(exports,{serve:()=>serve,mutate:()=>mutate});const _react=require("react");const _client=_interopRequireDefault(require("react-server-dom-webpack/client"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const{createFromFetch,encodeReply}=_client.default;const basePath="/";function serve(rscId){const fetchRSC=(0,_react.cache)(serializedProps=>{let rerender;const setRerender=fn=>{rerender=fn;return()=>{rerender=undefined}};const searchParams=new URLSearchParams;searchParams.set("props",serializedProps);const options={async callServer(rsfId,args){const isMutating=!!mutationMode;const searchParams=new URLSearchParams;searchParams.set("action_id",rsfId);let rscPath="RSC/";if(isMutating){rscPath+=rscId;searchParams.set("props",serializedProps)}else{rscPath+="_"}const response=fetch(basePath+rscPath+"/"+searchParams,{method:"POST",body:await encodeReply(args)});const data=createFromFetch(response,options);if(isMutating){rerender?.([data,serializedProps])}return data}};const prefetched=globalThis.__WAKUWORK_PREFETCHED__?.[rscId]?.[serializedProps];const rscPath="RSC/"+rscId;const data=createFromFetch(prefetched||fetch(basePath+rscPath+"/"+searchParams),options);return[data,setRerender]});const ServerComponent=props=>{const serializedProps=JSON.stringify(props);const[data,setRerender]=fetchRSC(serializedProps);const[state,setState]=(0,_react.useState)();(0,_react.useEffect)(()=>setRerender(setState));let dataToReturn=data;if(state){if(state[1]===serializedProps){dataToReturn=state[0]}else{setState(undefined)}}return(0,_react.use)(dataToReturn)};return ServerComponent}let mutationMode=0;function mutate(fn){++mutationMode;fn();--mutationMode}