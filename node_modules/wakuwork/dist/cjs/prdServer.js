"use strict";Object.defineProperty(exports,"__esModule",{value:true});Object.defineProperty(exports,"startPrdServer",{enumerable:true,get:()=>startPrdServer});const _nodeHttp=_interopRequireDefault(require("node:http"));const _commonJs=require("./middleware/common.js");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap;var cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}function startPrdServer(config={}){const shared={};const middlewares=config.prdServer?.middlewares||["staticFile","rewriteRsc","rscPrd","indexFallback","notFound"];const resolvedMiddlewares=Promise.all(middlewares.map(async middleware=>{if(typeof middleware==="string"){const mod=await Promise.resolve(`./middleware/${middleware}.js`).then(p=>_interopRequireWildcard(require(p)));return(mod.default||mod)(config,shared)}return middleware}));const server=_nodeHttp.default.createServer(async(req,res)=>{try{await (0,_commonJs.pipe)(await resolvedMiddlewares)(req,res,async()=>{});return}catch(e){console.info(e)}res.statusCode=500;res.end()});const port=config.prdServer?.port??8080;server.listen(port,()=>{console.info("Listening on",port)})}