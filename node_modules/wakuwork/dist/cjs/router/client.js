"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _export(target,all){for(var name in all)Object.defineProperty(target,name,{enumerable:true,get:all[name]})}_export(exports,{useChangeLocation:()=>useChangeLocation,useLocation:()=>useLocation,Link:()=>Link,Router:()=>Router});const _react=require("react");const _clientJs=require("../client.js");const _commonJs=require("./common.js");const RouterContext=(0,_react.createContext)(null);function useChangeLocation(){const value=(0,_react.useContext)(RouterContext);if(!value){throw new Error("Missing Router")}return value.changeLocation}function useLocation(){const value=(0,_react.useContext)(RouterContext);if(!value){throw new Error("Missing Router")}return value.location}const prefetchRoutes=(pathname,search)=>{const prefetched=globalThis.__WAKUWORK_PREFETCHED__||={};const pathItems=pathname.split("/").filter(Boolean);for(let index=0;index<=pathItems.length;++index){const rscId=pathItems.slice(0,index).join("/")||"index";const props={index,search};const serializedProps=JSON.stringify(props);if(!prefetched[rscId]){prefetched[rscId]={}}const searchParams=new URLSearchParams;searchParams.set("props",serializedProps);if(!prefetched[rscId][serializedProps]){prefetched[rscId][serializedProps]=fetch(`/RSC/${rscId}/${searchParams}`)}}};const getRoute=(0,_react.cache)(rscId=>(0,_clientJs.serve)(rscId));const Child=({index})=>{const{pathname,search}=useLocation();const pathItems=pathname.split("/").filter(Boolean);if(index>pathItems.length){return null}const rscId=pathItems.slice(0,index).join("/")||"index";return(0,_react.createElement)(getRoute(rscId),{index,search})};function Link({href,children,pending,notPending,unstable_prefetchOnEnter}){const changeLocation=useChangeLocation();const[isPending,startTransition]=(0,_react.useTransition)();const onClick=event=>{event.preventDefault();const url=new URL(href,window.location.href);if(url.href!==window.location.href){startTransition(()=>{changeLocation(url.pathname,url.search)})}};const onMouseEnter=unstable_prefetchOnEnter?()=>{const url=new URL(href,window.location.href);if(url.href!==window.location.href){prefetchRoutes(url.pathname,url.search)}}:undefined;const ele=(0,_react.createElement)("a",{href,onClick,onMouseEnter},children);if(isPending&&pending!==undefined){return(0,_react.createElement)(_react.Fragment,null,ele,pending)}if(!isPending&&notPending!==undefined){return(0,_react.createElement)(_react.Fragment,null,ele,notPending)}return ele}const moduleCache=globalThis.__webpack_require__wakuwork_cache||=new Map;moduleCache.set(_commonJs.WAKUWORK_ROUTER,{Child,Link});const parseLocation=()=>{const{pathname,search}=window.location;return{pathname,search}};function Router(){const[location,setLocation]=(0,_react.useState)(parseLocation);const changeLocation=(pathname,search,replace)=>{const url=new URL(window.location.href);if(pathname){url.pathname=pathname}if(search){url.search=search}if(replace){window.history.replaceState(null,"",url)}else{window.history.pushState(null,"",url)}setLocation(parseLocation())};(0,_react.useEffect)(()=>{const callback=()=>setLocation(parseLocation());window.addEventListener("popstate",callback);return()=>window.removeEventListener("popstate",callback)},[]);prefetchRoutes(location.pathname,location.search);return(0,_react.createElement)(RouterContext.Provider,{value:{location,changeLocation}},(0,_react.createElement)(Child,{index:0}))}