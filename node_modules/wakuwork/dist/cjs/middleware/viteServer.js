"use strict";Object.defineProperty(exports,"__esModule",{value:true});Object.defineProperty(exports,"default",{enumerable:true,get:()=>_default});const _nodePath=_interopRequireDefault(require("node:path"));const _nodeFs=_interopRequireDefault(require("node:fs"));const _promises=_interopRequireDefault(require("node:fs/promises"));const _vite=require("vite");const _pluginReact=_interopRequireDefault(require("@vitejs/plugin-react"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const rscPlugin=scriptToInject=>{return{name:"rscPlugin",async transformIndexHtml(_html,ctx){const code=await scriptToInject(ctx.path);if(code){return[{tag:"script",children:code,injectTo:"body"}]}}}};const viteServer=(config,shared)=>{const dir=_nodePath.default.resolve(config.devServer?.dir||".");const indexHtml=config.files?.indexHtml||"index.html";const indexHtmlFile=_nodePath.default.join(dir,indexHtml);const vitePromise=(0,_vite.createServer)({root:dir,plugins:[(0,_pluginReact.default)(),rscPlugin(async path=>shared.devScriptToInject?.(path)||"")],server:{middlewareMode:true},appType:"custom"});return async(req,res,next)=>{const vite=await vitePromise;const indexFallback=async()=>{const url=new URL(req.url||"","http://"+req.headers.host);const hasExtension=url.pathname.split(".").length>1;if(!hasExtension){const fname=indexHtmlFile;if(_nodeFs.default.existsSync(fname)){let content=await _promises.default.readFile(fname,{encoding:"utf-8"});content=await vite.transformIndexHtml(req.url||"",content);res.setHeader("Content-Type","text/html; charset=utf-8");res.end(content);return}res.statusCode=404;res.end();return}await next()};return new Promise((resolve,reject)=>vite.middlewares(req,res,err=>err?reject(err):resolve(indexFallback())))}};const _default=viteServer;